<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Randevum - Profesyonel Takip</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url("https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;700;800&display=swap");

        :root {
            --bg: #0f111a;
            --panel: #161b2b;
            --panel-2: #1c233a;
            --border: #2d3748;
            --text: #e2e8f0;
            --muted: #94a3b8;
            --accent: #a855f7;
            --cyan: #22d3ee;
            --emerald: #10b981;
        }

        body.light-mode {
            --bg: #f1f5f9;
            --panel: #ffffff;
            --panel-2: #f8fafc;
            --border: #cbd5e1;
            --text: #0f172a;
            --muted: #475569;
        }

        body.light-mode .input-field {
            background-color: #f8fafc;
            color: #0f172a;
            border-color: #cbd5e1;
        }

        body.light-mode .calendar-day {
            background-color: #ffffff;
        }

        body.light-mode .bg-slate-800 {
            background-color: #e2e8f0;
            color: #1e293b;
        }

        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: "Manrope", sans-serif;
            transition: background-color 0.3s, color 0.3s;
        }

        .panel {
            background-color: var(--panel);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
        }

        .input-field {
            background-color: #0f111a;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.6rem 1rem;
            width: 100%;
            color: white;
            outline: none;
        }

        .input-field:focus {
            border-color: var(--cyan);
        }

        .btn-save {
            background: linear-gradient(90deg, #22d3ee, #a855f7);
            color: #0f111a;
            font-weight: 800;
            padding: 0.6rem 1.5rem;
            border-radius: 10px;
            transition: opacity 0.2s;
        }

        .btn-save:hover {
            opacity: 0.9;
        }

        .btn-save:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .loading-spinner {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            border: 2px solid rgba(0,0,0,0.3);
            border-radius: 50%;
            border-top-color: #000;
            animation: spin 1s ease-in-out infinite;
            margin-right: 0.5rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .calendar-day {
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 0.5rem;
            min-height: 80px;
            cursor: pointer;
            transition: all 0.2s;
            background: var(--panel);
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .calendar-day:hover {
            border-color: var(--cyan);
            transform: translateY(-2px);
        }

        .calendar-day.loading {
            opacity: 0.5;
            pointer-events: none;
            background: linear-gradient(90deg, var(--panel) 25%, var(--panel-2) 50%, var(--panel) 75%);
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s infinite;
        }

        @keyframes skeleton-loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .calendar-day.selected {
            border-color: var(--emerald);
            box-shadow: 0 0 0 1px var(--emerald);
        }

        .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
        }

        @media print {
            .no-print { display: none !important; }
            body { background: white !important; color: black !important; padding: 0 !important; }
            .panel { border: none !important; background: white !important; padding: 0 !important; margin: 0 !important; }
            .print-only { display: block !important; }
            .print-header { margin-bottom: 2rem; border-bottom: 2px solid #000; padding-bottom: 1rem; }
            .print-table { width: 100%; border-collapse: collapse; }
            .print-table th, .print-table td { border: 1px solid #ddd; padding: 8px; text-align: left; font-size: 12px; }
            .print-table th { background-color: #f2f2f2 !important; -webkit-print-color-adjust: exact; }
        }

        .print-only { display: none; }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            backdrop-filter: blur(4px);
            overflow-y: auto;
        }

        .modal-content {
            background-color: var(--panel);
            margin: 2rem auto;
            padding: 2rem;
            border: 1px solid var(--border);
            width: 90%;
            max-width: 600px;
            border-radius: 16px;
            position: relative;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        .close-modal {
            position: absolute;
            right: 1.5rem;
            top: 1.5rem;
            color: var(--muted);
            cursor: pointer;
            font-size: 1.5rem;
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <!-- Print View -->
    <div id="print-area" class="print-only">
        <div class="print-header flex justify-between items-end">
            <div>
                <h1 class="text-2xl font-bold">Randevu Listesi</h1>
                <p id="print-instructor-name" class="text-lg font-semibold"></p>
            </div>
            <div class="text-right">
                <p id="print-date-val" class="font-bold"></p>
                <p class="text-xs text-slate-500">Oluşturulma: <span id="print-now"></span></p>
            </div>
        </div>
        <table class="print-table">
            <thead>
                <tr>
                    <th>Saat</th>
                    <th>Müşteri Ad Soyad</th>
                    <th>Başlık</th>
                    <th>Telefon</th>
                    <th>Not</th>
                </tr>
            </thead>
            <tbody id="print-table-body"></tbody>
        </table>
    </div>

    <div class="max-w-6xl mx-auto space-y-8 no-print">
        
        <!-- Header -->
        <header class="flex justify-between items-center no-print">
            <div class="flex items-center gap-4">
                <div class="bg-slate-800 px-3 py-1 rounded-full text-xs font-bold flex gap-4">
                    <span id="live-date">-- --</span>
                    <span id="live-time" class="text-slate-400">--:--:--</span>
                </div>
                <button id="theme-toggle" class="flex items-center gap-2 text-xs font-bold text-cyan-400 bg-slate-800/50 px-3 py-1 rounded-full border border-slate-700/50 hover:border-cyan-400/50 transition-all">
                    <span id="theme-text">Koyu Mod</span>
                    <svg id="sun-icon" class="hidden" xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="4.22" x2="19.78" y2="5.64"/></svg>
                    <svg id="moon-icon" xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
                </button>
            </div>
            <div class="flex items-center gap-6">
                <h1 class="text-2xl font-extrabold tracking-tighter">Randevum</h1>
                <button id="open-settings" class="text-slate-400 hover:text-white transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>
                </button>
            </div>
        </header>

        <!-- Settings Modal -->
        <div id="settings-modal" class="modal no-print">
            <div class="modal-content">
                <span class="close-modal">&times;</span>
                <h2 class="text-xl font-bold mb-6">Ayarlar</h2>
                
                <div class="space-y-6">
                    <div class="grid grid-cols-1 gap-4">
                        <input type="hidden" id="settings-start" value="{{ settings.start_time }}">
                        <input type="hidden" id="settings-end" value="{{ settings.end_time }}">
                        <div>
                            <label class="text-xs font-bold text-slate-500 block mb-1">Randevu Süresi (dk)</label>
                            <input type="number" id="settings-duration" class="input-field" value="{{ settings.appointment_duration }}">
                        </div>
                    </div>

                    <div>
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-sm font-bold text-slate-400 uppercase">Hocalar</h3>
                            <button id="add-instructor-btn" class="text-xs bg-cyan-500/10 text-cyan-400 px-3 py-1 rounded-full font-bold hover:bg-cyan-500/20">Hoca Ekle</button>
                        </div>
                        <div id="instructor-settings" class="space-y-3 max-h-60 overflow-y-auto pr-2">
                            <!-- Instructor inputs will be here -->
                        </div>
                    </div>

                    <div class="pt-4 border-t border-slate-800">
                        <button id="save-settings-btn" class="btn-save w-full">Ayarları Kaydet</button>
                    </div>
                </div>
            </div>
        </div>


        <!-- Calendar Section -->
        <section class="panel">
            <div class="flex justify-between items-center mb-6 no-print">
                <div>
                    <h2 class="text-xs font-bold text-slate-500 uppercase">AY GÖRÜNÜMÜ</h2>
                    <h3 id="month-label" class="text-xl font-extrabold">Ocak 2026</h3>
                </div>
                <div class="flex gap-2">
                    <button id="prev-month" class="bg-slate-800 px-4 py-2 rounded-lg text-sm font-bold">Önceki</button>
                    <button id="next-month" class="bg-slate-800 px-4 py-2 rounded-lg text-sm font-bold">Sonraki</button>
                </div>
            </div>

            <div class="grid grid-cols-7 gap-2 mb-2 text-center text-[10px] font-bold text-slate-500 no-print">
                <div>PZT</div><div>SAL</div><div>ÇAR</div><div>PER</div><div>CUM</div><div>CTS</div><div>PAZ</div>
            </div>
            <div id="calendar-grid" class="grid grid-cols-7 gap-2">
                <!-- Calendar days will be here -->
            </div>
            <div class="mt-4 flex items-center gap-2 text-xs text-slate-500 no-print">
                <span class="dot bg-cyan-400"></span> randevulu gün
            </div>
        </section>

        <!-- Appointment Form Section -->
        <section class="panel no-print">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h2 class="text-xs font-bold text-slate-500 uppercase">GÜN SEÇİMİ</h2>
                    <h3 id="selected-date-display" class="text-xl font-extrabold">-- -- ----</h3>
                </div>
                <div id="day-stats" class="bg-emerald-500/10 text-emerald-400 px-4 py-2 rounded-full text-sm font-bold">
                    0 dolu • 72 boş
                </div>
            </div>

            <form id="appointment-form" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="text-xs font-bold text-slate-500 block mb-1">Hoca seç</label>
                        <select id="instructor-select" class="input-field" required></select>
                    </div>
                    <div>
                        <label class="text-xs font-bold text-slate-500 block mb-1">Başlangıç Saati</label>
                        <select id="slot-select" class="input-field" required></select>
                    </div>
                </div>

                <div>
                    <label class="text-xs font-bold text-slate-500 block mb-1">Randevu başlığı</label>
                    <input type="text" id="title-input" class="input-field" placeholder="Örn: Diyet kontrol" required>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="text-xs font-bold text-slate-500 block mb-1">Ad Soyad</label>
                        <input type="text" id="full-name" class="input-field" placeholder="Ad Soyad" required>
                    </div>
                    <div>
                        <label class="text-xs font-bold text-slate-500 block mb-1">Telefon</label>
                        <input type="text" id="phone" class="input-field" placeholder="05xx xxx xx xx" required>
                    </div>
                    <div>
                        <label class="text-xs font-bold text-slate-500 block mb-1">Not (opsiyonel)</label>
                        <textarea id="note-input" class="input-field" rows="1" placeholder="Danışan adı, amaç, hatırlatma..."></textarea>
                    </div>
                </div>

                <div class="flex gap-2">
                    <button type="submit" id="save-btn" class="btn-save text-sm">Kaydet</button>
                    <button type="button" id="reset-btn" class="bg-slate-800 px-6 py-2 rounded-lg text-sm font-bold">Temizle</button>
                </div>
                <p class="text-[10px] text-slate-500">Veriler tarayıcı hafızasında saklanır; sayfa yenilenince silinmez.</p>
            </form>
        </section>

        <!-- Daily Appointments List -->
        <section class="panel">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h2 class="text-xs font-bold text-slate-500 uppercase">GÜNLÜK DÖKÜM</h2>
                    <h3 class="text-xl font-extrabold">Seçilen günün randevuları</h3>
                </div>
                <div id="print-date-display" class="bg-slate-800 px-4 py-2 rounded-lg text-xs font-bold">
                    Gün: -- -- ----
                </div>
            </div>
            <div id="booking-list" class="text-sm text-slate-400">
                Henüz randevu yok. Gün ve hoca seçip 15 dk slot ekleyebilirsin.
            </div>
        </section>

        <!-- Instructor Summary -->
        <section class="panel no-print">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-extrabold">Randevular</h2>
                <div class="flex gap-4 items-center">
                    <span id="summary-hours" class="bg-slate-800 px-4 py-1 rounded-full text-xs font-bold">09:00 - 17:00</span>
                    <button onclick="window.print()" class="bg-slate-800 px-4 py-2 rounded-lg text-sm font-bold">Günü yazdır</button>
                </div>
            </div>
            <div id="instructor-summary-list" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <!-- Instructor summary cards will be here -->
            </div>
        </section>

    </div>

    {{ instructors|json_script:"instructor-data" }}
    {{ settings|json_script:"settings-data" }}

    <script>
    (function() {
        const monthNames = ["Ocak", "Şubat", "Mart", "Nisan", "Mayıs", "Haziran", "Temmuz", "Ağustos", "Eylül", "Ekim", "Kasım", "Aralık"];
        let instructors = JSON.parse(document.getElementById("instructor-data").textContent || "[]");
        const globalSettings = JSON.parse(document.getElementById("settings-data").textContent || '{"start_time":"09:00","end_time":"17:00","appointment_duration":15}');
        
        let bookings = [];
        let selectedDate = new Date();
        let currentMonth = selectedDate.getMonth();
        let currentYear = selectedDate.getFullYear();
        let editingId = null;

        async function init() {
            // Theme init
            if (localStorage.getItem('theme') === 'light') {
                document.body.classList.add('light-mode');
                updateThemeUI();
            }

            renderInstructorSettings();
            // renderWorkingHours(); // Removed as the element was deleted
            renderInstructorSelect();
            updateClock();
            setInterval(updateClock, 1000);
            await loadBookings();
            selectDate(new Date());

            document.getElementById("prev-month").onclick = () => changeMonth(-1);
            document.getElementById("next-month").onclick = () => changeMonth(1);
            document.getElementById("appointment-form").onsubmit = saveAppointment;
            document.getElementById("reset-btn").onclick = resetForm;
            document.getElementById("save-settings-btn").onclick = saveSettings;
            document.getElementById("instructor-select").onchange = renderSlotOptions;
            
            // Modal events
            const modal = document.getElementById("settings-modal");
            document.getElementById("open-settings").onclick = () => modal.style.display = "block";
            document.querySelector(".close-modal").onclick = () => modal.style.display = "none";
            window.onclick = (e) => { if (e.target == modal) modal.style.display = "none"; };
            
            document.getElementById("add-instructor-btn").onclick = addInstructorRow;
            document.getElementById("theme-toggle").onclick = toggleTheme;
        }

        function toggleTheme() {
            document.body.classList.toggle('light-mode');
            const isLight = document.body.classList.contains('light-mode');
            localStorage.setItem('theme', isLight ? 'light' : 'dark');
            updateThemeUI();
        }

        function updateThemeUI() {
            const isLight = document.body.classList.contains('light-mode');
            document.getElementById("theme-text").textContent = isLight ? "Açık Mod" : "Koyu Mod";
            document.getElementById("sun-icon").classList.toggle('hidden', !isLight);
            document.getElementById("moon-icon").classList.toggle('hidden', isLight);
        }

        async function loadBookings() {
            const grid = document.getElementById("calendar-grid");
            
            // If grid is empty (first load), show skeleton cells
            if (grid.children.length === 0) {
                grid.innerHTML = Array(31).fill(0).map(() => `
                    <div class="calendar-day loading">
                        <div class="h-4 w-8 bg-slate-700/50 rounded animate-pulse"></div>
                        <div class="h-3 w-12 bg-slate-700/50 rounded animate-pulse mt-2"></div>
                    </div>
                `).join("");
            } else {
                const cells = grid.querySelectorAll(".calendar-day");
                cells.forEach(c => c.classList.add('loading'));
            }

            try {
                const response = await fetch('/api/appointments/');
                bookings = await response.json();
                renderCalendar();
                renderBookings();
                renderInstructorSummary();
            } catch (e) { 
                console.error(e); 
            }
        }

        function renderInstructorSettings() {
            const container = document.getElementById("instructor-settings");
            container.innerHTML = "";
            
            instructors.forEach(inst => {
                const div = document.createElement("div");
                div.className = "flex gap-3 items-center bg-slate-800/50 p-2 rounded-lg";
                div.innerHTML = `
                    <input type="text" class="input-field inst-name text-sm" data-id="${inst.id_name}" value="${inst.name}" placeholder="Hoca Adı">
                    <input type="color" class="w-12 h-8 rounded bg-transparent border-none cursor-pointer inst-color" value="${inst.color}">
                    <button onclick="removeInstructorRow(this)" class="text-red-400 hover:text-red-300 p-1">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>
                    </button>
                `;
                container.appendChild(div);
            });
        }

        function addInstructorRow() {
            const container = document.getElementById("instructor-settings");
            const id = 'inst-' + Date.now();
            const div = document.createElement("div");
            div.className = "flex gap-3 items-center bg-slate-800/50 p-2 rounded-lg";
            div.innerHTML = `
                <input type="text" class="input-field inst-name text-sm" data-id="${id}" value="" placeholder="Hoca Adı">
                <input type="color" class="w-12 h-8 rounded bg-transparent border-none cursor-pointer inst-color" value="#22d3ee">
                <button onclick="removeInstructorRow(this)" class="text-red-400 hover:text-red-300 p-1">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>
                </button>
            `;
            container.appendChild(div);
        }

        window.removeInstructorRow = (btn) => {
            btn.parentElement.remove();
        };

        async function saveSettings() {
            const btn = document.getElementById("save-settings-btn");
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = `<span class="loading-spinner"></span> Kaydediliyor...`;

            const start = document.getElementById("settings-start").value;
            const end = document.getElementById("settings-end").value;
            const duration = document.getElementById("settings-duration").value;
            const instInputs = document.querySelectorAll("#instructor-settings > div");
            const instData = Array.from(instInputs).map(div => ({
                id_name: div.querySelector(".inst-name").dataset.id,
                name: div.querySelector(".inst-name").value,
                color: div.querySelector(".inst-color").value
            })).filter(i => i.name.trim() !== "");

            try {
                const response = await fetch('/api/settings/save/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        start_time: start,
                        end_time: end,
                        appointment_duration: duration,
                        instructors: instData
                    })
                });
                if (response.ok) location.reload();
            } catch (e) { 
                console.error(e);
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }


        function renderCalendar() {
            const grid = document.getElementById("calendar-grid");
            grid.innerHTML = "";
            const firstDay = new Date(currentYear, currentMonth, 1);
            const lastDay = new Date(currentYear, currentMonth + 1, 0).getDate();
            const startWeek = (firstDay.getDay() + 6) % 7;
            
            document.getElementById("month-label").textContent = `${monthNames[currentMonth]} ${currentYear}`;

            const slotMinutes = parseInt(globalSettings.appointment_duration || 15);
            const [sH, sM] = globalSettings.start_time.split(':').map(Number);
            const [eH, eM] = globalSettings.end_time.split(':').map(Number);
            const totalMinutes = (eH * 60 + eM) - (sH * 60 + sM);
            const dayCapacity = Math.floor(totalMinutes / slotMinutes) * instructors.length;

            for (let i = 0; i < startWeek; i++) grid.appendChild(document.createElement("div"));

            for (let day = 1; day <= lastDay; day++) {
                const dateObj = new Date(currentYear, currentMonth, day);
                const iso = toISO(dateObj);
                const cell = document.createElement("div");
                
                const dayBookings = bookings.filter(b => b.date === iso);
                const busyCount = dayBookings.length;
                const percent = dayCapacity > 0 ? Math.round((busyCount / dayCapacity) * 100) : 0;

                // Dynamic background based on percentage
                let bgClass = "";
                let barColor = "bg-cyan-500";
                if (percent > 0 && percent <= 30) { bgClass = "bg-emerald-500/5"; barColor = "bg-emerald-500"; }
                else if (percent > 30 && percent <= 70) { bgClass = "bg-orange-500/5"; barColor = "bg-orange-500"; }
                else if (percent > 70) { bgClass = "bg-red-500/5"; barColor = "bg-red-500"; }

                cell.className = `calendar-day ${iso === toISO(selectedDate) ? 'selected' : ''} ${bgClass}`;
                
                cell.innerHTML = `
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center relative z-10">
                        <span class="text-sm font-bold">${day}</span>
                        <span class="text-[7px] md:text-[10px] text-slate-500 uppercase">${["PAZ","PZT","SAL","ÇAR","PER","CUM","CTS"][dateObj.getDay()]}</span>
                    </div>
                    <div class="mt-1 text-[8px] md:text-[10px] font-bold text-slate-400 relative z-10">
                        ${busyCount}/${dayCapacity} <span class="hidden md:inline">(%${percent})</span>
                    </div>
                    <div class="absolute bottom-0 left-0 w-full h-1 bg-slate-800/50">
                        <div class="h-full ${barColor} transition-all duration-500" style="width: ${percent}%"></div>
                    </div>
                `;

                cell.onclick = () => selectDate(dateObj);
                grid.appendChild(cell);
            }
        }

        function selectDate(date) {
            selectedDate = date;
            const iso = toISO(date);
            document.getElementById("selected-date-display").textContent = `${date.getDate()} ${monthNames[date.getMonth()]} ${date.getFullYear()}`;
            document.getElementById("print-date-display").textContent = `Gün: ${date.getDate()} ${monthNames[date.getMonth()]} ${date.getFullYear()}`;
            
            renderCalendar();
            renderBookings();
            renderSlotOptions();
            renderInstructorSummary();
        }

        function renderBookings() {
            const list = document.getElementById("booking-list");
            list.innerHTML = "";
            const iso = toISO(selectedDate);
            const dayBookings = bookings.filter(b => b.date === iso).sort((a, b) => a.time.localeCompare(b.time));

            const slotMinutes = 15;
            const [sH, sM] = globalSettings.start_time.split(':').map(Number);
            const [eH, eM] = globalSettings.end_time.split(':').map(Number);
            const totalMinutes = (eH * 60 + eM) - (sH * 60 + sM);
            const dayCapacity = (totalMinutes / slotMinutes) * instructors.length;
            const busy = dayBookings.reduce((sum, b) => sum + (b.attendees || 1), 0);
            
            document.getElementById("day-stats").textContent = `${busy} dolu • ${dayCapacity - busy} boş`;

            if (dayBookings.length === 0) {
                list.innerHTML = "Henüz randevu yok. Gün ve hoca seçip 15 dk slot ekleyebilirsin.";
                return;
            }

            dayBookings.forEach(b => {
                const inst = instructors.find(i => i.id_name === b.instructor);
                const endTime = minsToTime(timeToMins(b.time) + b.duration);
                const div = document.createElement("div");
                div.className = "flex justify-between items-center p-3 border-b border-slate-800 group";
                div.innerHTML = `
                    <div class="flex gap-4 items-center">
                        <div class="flex flex-col items-center min-w-[60px]">
                            <span class="font-bold text-white">${b.time}</span>
                            <span class="text-[10px] text-slate-500">${endTime}</span>
                        </div>
                        <span class="dot" style="background:${inst?.color}"></span>
                        <div>
                            <div class="font-bold text-slate-200">${b.title}</div>
                            <div class="text-xs text-slate-500">${b.client} • ${inst?.name} • ${b.attendees} kişi</div>
                        </div>
                    </div>
                    <div class="flex gap-2 opacity-0 group-hover:opacity-100">
                        <button onclick="window.editBooking(${b.id})" class="text-cyan-400 hover:underline">Düzenle</button>
                        <button onclick="window.deleteBooking(${b.id})" class="text-red-400 hover:underline">Sil</button>
                    </div>
                `;
                list.appendChild(div);
            });
        }

        function renderInstructorSummary() {
            const container = document.getElementById("instructor-summary-list");
            container.innerHTML = "";
            const iso = toISO(selectedDate);
            
            const slotMinutes = 15;
            const [sH, sM] = globalSettings.start_time.split(':').map(Number);
            const [eH, eM] = globalSettings.end_time.split(':').map(Number);
            const totalMinutes = (eH * 60 + eM) - (sH * 60 + sM);
            const instCapacity = totalMinutes / slotMinutes;

            document.getElementById("summary-hours").textContent = `${globalSettings.start_time} - ${globalSettings.end_time}`;

            instructors.forEach(inst => {
                const instBookings = bookings.filter(b => b.date === iso && b.instructor === inst.id_name);
                const busy = instBookings.reduce((sum, b) => sum + (b.attendees || 1), 0);
                
                const div = document.createElement("div");
                div.className = "border border-slate-800 rounded-xl p-4 flex justify-between items-center";
                div.innerHTML = `
                    <div class="flex items-center gap-3">
                        <span class="dot" style="background:${inst.color}"></span>
                        <span class="font-bold">${inst.name}</span>
                        <span class="bg-cyan-400/10 text-cyan-400 px-2 py-0.5 rounded text-[10px] font-bold">${instCapacity - busy} boş</span>
                    </div>
                    <button onclick="printInstructor('${inst.id_name}')" class="text-xs font-bold text-slate-400 hover:text-white">Yazdır</button>
                `;
                container.appendChild(div);
            });
        }

        function renderSlotOptions() {
            const select = document.getElementById("slot-select");
            const instructorId = document.getElementById("instructor-select").value;
            const iso = toISO(selectedDate);
            
            // Current appointment duration from settings
            const currentDuration = parseInt(globalSettings.appointment_duration || 15);
            const step = currentDuration; // ONLY duration, no gap
            
            const taken = bookings
                .filter(b => b.date === iso && b.instructor === instructorId && b.id !== editingId)
                .map(b => ({ 
                    start: timeToMins(b.time), 
                    end: timeToMins(b.time) + b.duration
                }));

            const [sH, sM] = globalSettings.start_time.split(':').map(Number);
            const [eH, eM] = globalSettings.end_time.split(':').map(Number);
            const startMins = sH * 60 + sM;
            const endMins = eH * 60 + eM;

            select.innerHTML = '<option value="">Saat Seçin</option>';
            for (let m = startMins; m <= endMins - currentDuration; m += step) {
                const time = minsToTime(m);
                const end = m + currentDuration;
                
                const isTaken = taken.some(t => {
                    const existingStart = t.start;
                    const existingEnd = t.end;
                    // Simple overlap check: (StartA < EndB) and (EndA > StartB)
                    return (m < existingEnd && end > existingStart);
                });

                if (!isTaken) {
                    const opt = document.createElement("option");
                    opt.value = time;
                    opt.textContent = time;
                    select.appendChild(opt);
                }
            }
        }

        function renderInstructorSelect() {
            const select = document.getElementById("instructor-select");
            select.innerHTML = instructors.map(i => `<option value="${i.id_name}">${i.name}</option>`).join("");
        }

        async function saveAppointment(e) {
            e.preventDefault();
            const timeVal = document.getElementById("slot-select").value;
            if (!timeVal) { alert("Lütfen saat seçin"); return; }

            const btn = document.getElementById("save-btn");
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = `<span class="loading-spinner"></span> Kaydediliyor...`;

            const record = {
                id: editingId,
                instructor: document.getElementById("instructor-select").value,
                date: toISO(selectedDate),
                time: timeVal,
                attendees: 1, // Default to 1 as requested
                title: document.getElementById("title-input").value,
                client: document.getElementById("full-name").value,
                phone: document.getElementById("phone").value,
                note: document.getElementById("note-input").value,
                duration: parseInt(globalSettings.appointment_duration || 15)
            };

            try {
                const response = await fetch('/api/appointments/save/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(record)
                });
                if (response.ok) {
                    editingId = null;
                    await loadBookings();
                    resetForm();
                }
            } catch (e) { console.error(e); }
            finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        window.editBooking = (id) => {
            const b = bookings.find(x => x.id === id);
            if (!b) return;
            editingId = id;
            document.getElementById("instructor-select").value = b.instructor;
            document.getElementById("title-input").value = b.title;
            // attendees field was removed from form, but we keep it in record
            document.getElementById("full-name").value = b.client;
            document.getElementById("phone").value = b.phone;
            document.getElementById("note-input").value = b.note;
            document.getElementById("save-btn").textContent = "Güncelle";
            renderSlotOptions();
            
            // Add the current booking's time to slot options if it's not there
            const select = document.getElementById("slot-select");
            if (!Array.from(select.options).some(opt => opt.value === b.time)) {
                const opt = document.createElement("option");
                opt.value = b.time;
                opt.textContent = b.time;
                select.appendChild(opt);
            }
            select.value = b.time;
        };

        window.deleteBooking = async (id) => {
            if (!confirm("Silmek istediğine emin misin?")) return;
            await fetch(`/api/appointments/delete/${id}/`, { method: 'DELETE' });
            await loadBookings();
        };

        function changeMonth(delta) {
            currentMonth += delta;
            if (currentMonth < 0) { currentMonth = 11; currentYear--; }
            if (currentMonth > 11) { currentMonth = 0; currentYear++; }
            renderCalendar();
        }

        function resetForm() {
            editingId = null;
            document.getElementById("appointment-form").reset();
            document.getElementById("save-btn").textContent = "Kaydet";
            renderSlotOptions();
        }

        function updateClock() {
            const now = new Date();
            document.getElementById("live-date").textContent = `${now.getDate()} ${monthNames[now.getMonth()]}`;
            document.getElementById("live-time").textContent = now.toLocaleTimeString('tr-TR');
        }

        function toISO(d) {
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        function timeToMins(t) { const [h, m] = t.split(':').map(Number); return h * 60 + m; }
        function minsToTime(m) { return `${String(Math.floor(m/60)).padStart(2,'0')}:${String(m%60).padStart(2,'0')}`; }

        window.printInstructor = (id_name) => {
            const inst = instructors.find(i => i.id_name === id_name);
            const iso = toISO(selectedDate);
            const dayBookings = bookings
                .filter(b => b.date === iso && b.instructor === id_name)
                .sort((a, b) => a.time.localeCompare(b.time));

            if (dayBookings.length === 0) {
                alert("Bu hocanın seçili günde randevusu bulunmuyor.");
                return;
            }

            // Fill print area
            document.getElementById("print-instructor-name").textContent = `Hoca: ${inst.name}`;
            document.getElementById("print-date-val").textContent = document.getElementById("selected-date-display").textContent;
            document.getElementById("print-now").textContent = new Date().toLocaleString('tr-TR');

            const tbody = document.getElementById("print-table-body");
            tbody.innerHTML = dayBookings.map(b => `
                <tr>
                    <td><b>${b.time} - ${minsToTime(timeToMins(b.time) + b.duration)}</b></td>
                    <td>${b.client}</td>
                    <td>${b.title}</td>
                    <td>${b.phone}</td>
                    <td>${b.note || '-'}</td>
                </tr>
            `).join("");

            window.print();
        };

        init();
    })();
    </script>
</body>
</html>
