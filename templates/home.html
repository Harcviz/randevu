<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Randevum - Profesyonel Takip</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url("https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;700;800&display=swap");

        :root {
            --bg: #080c18;
            --panel: #0f172a;
            --panel-2: #0b1224;
            --panel-3: #101827;
            --border: #1f2937;
            --text: #e5e7eb;
            --muted: #a3adc2;
            --accent: #22d3ee;
            --emerald: #22c55e;
            --shadow: 0 16px 32px rgba(0, 0, 0, 0.28);
            --day-size: 100px;
        }

        body {
            margin: 0;
            padding: 0;
            min-height: 100vh;
            background: radial-gradient(130% 140% at 20% 20%, #11162a, #050815 55%, #030611);
            color: var(--text);
            font-family: "Manrope", sans-serif;
            line-height: 1.5;
        }

        .page {
            max-width: 1280px;
            margin: 0 auto;
            padding: 1rem;
        }

        .panel {
            background: linear-gradient(155deg, rgba(255, 255, 255, 0.02), rgba(255, 255, 255, 0.01));
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 1.25rem;
            box-shadow: var(--shadow);
            backdrop-filter: blur(8px);
        }

        .btn, .btn-ghost {
            border: 1px solid var(--border);
            background: var(--panel-2);
            color: var(--text);
            border-radius: 12px;
            padding: 0.6rem 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .btn:hover, .btn-ghost:hover {
            transform: translateY(-1px);
            background: var(--panel-3);
            border-color: var(--accent);
        }

        .btn-primary {
            background: linear-gradient(90deg, #22d3ee, #a855f7);
            border: none;
            color: #0b0f1a;
        }

        .btn-danger {
            background: rgba(248, 113, 113, 0.1);
            color: #fecdd3;
            border-color: rgba(248, 113, 113, 0.3);
        }

        input, select, textarea {
            width: 100%;
            background: var(--panel-2);
            border: 1px solid var(--border);
            color: var(--text);
            border-radius: 12px;
            padding: 0.75rem 1rem;
            outline: none;
            transition: all 0.2s ease;
        }

        input:focus, select:focus, textarea:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 2px rgba(34, 211, 238, 0.2);
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.5rem;
        }

        .day-cell {
            aspect-ratio: 1/1;
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 0.5rem;
            background: var(--panel-2);
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
        }

        .day-cell:hover {
            border-color: var(--accent);
            transform: scale(1.02);
        }

        .day-cell.selected {
            border-color: var(--accent);
            background: rgba(34, 211, 238, 0.05);
        }

        .day-cell.today {
            border-color: var(--emerald);
        }

        .day-cell::after {
            content: "";
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: var(--accent);
            transform: scaleX(var(--fill, 0));
            transition: transform 0.3s ease;
        }

        .dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
        }

        @media (max-width: 768px) {
            .calendar-grid {
                gap: 4px;
            }
            .day-cell {
                padding: 4px;
            }
            .day-number {
                font-size: 0.8rem;
            }
            .day-week {
                display: none;
            }
        }
    </style>
</head>
<body>
<div class="page">
    <!-- Header -->
    <header class="flex flex-col md:flex-row justify-between items-center gap-4 mb-8">
        <div class="text-center md:text-left">
            <h1 class="text-3xl md:text-4xl font-extrabold tracking-tight">Randevum</h1>
            <p class="text-slate-400 text-sm">Profesyonel Randevu Takip Sistemi</p>
        </div>
        <div class="flex items-center gap-3">
            <div class="panel py-2 px-4 flex items-center gap-4">
                <span id="live-date" class="text-sm font-bold">-- --</span>
                <span id="live-time" class="text-sm font-mono text-cyan-400">--:--:--</span>
            </div>
            <a href="{% url 'logout' %}" class="btn-ghost p-2 text-red-400 hover:bg-red-500/10 border-red-500/20" title="Çıkış Yap">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
            </a>
        </div>
    </header>

    <!-- Main Content -->
    <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
        
        <!-- Left Column: Calendar -->
        <div class="lg:col-span-8 space-y-6">
            <section class="panel">
                <div class="flex justify-between items-center mb-6">
                    <h2 id="month-label" class="text-xl font-bold">Aralık 2025</h2>
                    <div class="flex gap-2">
                        <button id="prev-month" class="btn-ghost p-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
                        </button>
                        <button id="next-month" class="btn-ghost p-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg>
                        </button>
                    </div>
                </div>
                
                <div class="grid grid-cols-7 gap-2 mb-2 text-center text-xs font-bold text-slate-500">
                    <div>PZT</div><div>SAL</div><div>ÇAR</div><div>PER</div><div>CUM</div><div>CTS</div><div>PAZ</div>
                </div>
                <div id="calendar-grid" class="calendar-grid"></div>
            </section>

            <!-- Daily List -->
            <section class="panel">
                <div class="flex justify-between items-center mb-4">
                    <div>
                        <h2 class="text-lg font-bold">Günlük Randevular</h2>
                        <p id="selected-date-label" class="text-sm text-slate-400">-- -- ----</p>
                    </div>
                    <button id="print-day" class="btn-ghost text-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9V2h12v7"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><path d="M6 14h12v8H6z"/></svg>
                        Yazdır
                    </button>
                </div>
                <div id="booking-list" class="space-y-3">
                    <!-- Bookings will be injected here -->
                </div>
            </section>
        </div>

        <!-- Right Column: Form -->
        <div class="lg:col-span-4 space-y-6">
            <section class="panel sticky top-4">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-lg font-bold">Yeni Randevu</h2>
                    <span id="day-availability" class="text-xs font-bold px-2 py-1 rounded-full bg-emerald-500/10 text-emerald-400">-- boş</span>
                </div>
                
                <form id="appointment-form" class="space-y-4">
                    <div>
                        <label class="text-xs font-bold text-slate-500 uppercase mb-1 block">Hoca</label>
                        <select id="instructor-select" required></select>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-xs font-bold text-slate-500 uppercase mb-1 block">Saat</label>
                            <select id="slot-select" required></select>
                        </div>
                        <div>
                            <label class="text-xs font-bold text-slate-500 uppercase mb-1 block">Kişi Sayısı</label>
                            <input type="number" id="attendees" min="1" max="10" value="1" required />
                        </div>
                    </div>

                    <div>
                        <label class="text-xs font-bold text-slate-500 uppercase mb-1 block">Randevu Başlığı</label>
                        <input type="text" id="title-input" placeholder="Örn: İlk Görüşme" required />
                    </div>

                    <div>
                        <label class="text-xs font-bold text-slate-500 uppercase mb-1 block">Danışan Ad Soyad</label>
                        <input type="text" id="full-name" placeholder="Ad Soyad" required />
                    </div>

                    <div>
                        <label class="text-xs font-bold text-slate-500 uppercase mb-1 block">Telefon</label>
                        <input type="tel" id="phone" placeholder="05xx xxx xx xx" required />
                    </div>

                    <div>
                        <label class="text-xs font-bold text-slate-500 uppercase mb-1 block">Notlar</label>
                        <textarea id="note-input" rows="3" placeholder="Ek bilgiler..."></textarea>
                    </div>

                    <div class="flex gap-2 pt-2">
                        <button type="submit" id="save-btn" class="btn btn-primary flex-1">Kaydet</button>
                        <button type="button" id="reset-btn" class="btn-ghost flex-1">Temizle</button>
                    </div>
                </form>
            </section>
        </div>
    </div>
</div>

{{ instructors|json_script:"instructor-data" }}

<script>
(function() {
    const monthNames = ["Ocak", "Şubat", "Mart", "Nisan", "Mayıs", "Haziran", "Temmuz", "Ağustos", "Eylül", "Ekim", "Kasım", "Aralık"];
    const weekdayNames = ["PZT", "SAL", "ÇAR", "PER", "CUM", "CTS", "PAZ"];
    const slotMinutes = 15;
    const startHour = 9;
    const endHour = 18;
    const dayCapacity = ((endHour - startHour) * 60) / slotMinutes;

    const instructors = JSON.parse(document.getElementById("instructor-data").textContent || "[]");
    let bookings = [];
    let selectedDate = new Date();
    let currentMonth = selectedDate.getMonth();
    let currentYear = selectedDate.getFullYear();
    let editingId = null;

    // Initialization
    async function init() {
        renderInstructorSelect();
        updateClock();
        setInterval(updateClock, 1000);
        await loadBookings();
        selectDate(new Date());
        
        // Event Listeners
        document.getElementById("prev-month").onclick = () => changeMonth(-1);
        document.getElementById("next-month").onclick = () => changeMonth(1);
        document.getElementById("appointment-form").onsubmit = saveAppointment;
        document.getElementById("reset-btn").onclick = resetForm;
        document.getElementById("instructor-select").onchange = renderSlotOptions;
        document.getElementById("attendees").oninput = renderSlotOptions;
        document.getElementById("print-day").onclick = printDay;
    }

    // API Calls
    async function loadBookings() {
        try {
            const response = await fetch('/api/appointments/');
            bookings = await response.json();
            renderCalendar();
            renderBookings();
        } catch (e) { console.error("Yükleme hatası:", e); }
    }

    async function saveAppointment(e) {
        e.preventDefault();
        const record = {
            id: editingId,
            instructor: document.getElementById("instructor-select").value,
            date: toISO(selectedDate),
            time: document.getElementById("slot-select").value,
            attendees: document.getElementById("attendees").value,
            title: document.getElementById("title-input").value,
            client: document.getElementById("full-name").value,
            phone: document.getElementById("phone").value,
            note: document.getElementById("note-input").value,
            duration: document.getElementById("attendees").value * slotMinutes
        };

        try {
            const response = await fetch('/api/appointments/save/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(record)
            });
            const res = await response.json();
            if (res.status === 'success') {
                editingId = null;
                await loadBookings();
                resetForm();
            } else { alert("Hata: " + res.message); }
        } catch (e) { console.error("Kayıt hatası:", e); }
    }

    async function deleteAppointment(id) {
        if (!confirm("Bu randevuyu silmek istediğinize emin misiniz?")) return;
        try {
            const response = await fetch(`/api/appointments/delete/${id}/`, { method: 'DELETE' });
            const res = await response.json();
            if (res.status === 'success') await loadBookings();
        } catch (e) { console.error("Silme hatası:", e); }
    }

    // UI Rendering
    function renderCalendar() {
        const grid = document.getElementById("calendar-grid");
        grid.innerHTML = "";
        const firstDay = new Date(currentYear, currentMonth, 1);
        const lastDay = new Date(currentYear, currentMonth + 1, 0).getDate();
        const startWeek = (firstDay.getDay() + 6) % 7;
        
        document.getElementById("month-label").textContent = `${monthNames[currentMonth]} ${currentYear}`;

        for (let i = 0; i < startWeek; i++) grid.appendChild(document.createElement("div"));

        for (let day = 1; day <= lastDay; day++) {
            const dateObj = new Date(currentYear, currentMonth, day);
            const iso = toISO(dateObj);
            const cell = document.createElement("div");
            cell.className = `day-cell ${iso === toISO(selectedDate) ? 'selected' : ''} ${iso === toISO(new Date()) ? 'today' : ''}`;
            
            const dayBookings = bookings.filter(b => b.date === iso);
            const busyCount = dayBookings.reduce((sum, b) => sum + (b.attendees || 1), 0);
            cell.style.setProperty("--fill", busyCount / dayCapacity);

            cell.innerHTML = `<span class="day-number font-bold">${day}</span>`;
            
            const dots = document.createElement("div");
            dots.className = "flex gap-1 mt-auto";
            const colors = [...new Set(dayBookings.map(b => instructors.find(i => i.id_name === b.instructor)?.color))];
            colors.forEach(c => {
                if (c) dots.innerHTML += `<span class="dot" style="background:${c}"></span>`;
            });
            cell.appendChild(dots);

            cell.onclick = () => selectDate(dateObj);
            grid.appendChild(cell);
        }
    }

    function renderBookings() {
        const list = document.getElementById("booking-list");
        list.innerHTML = "";
        const iso = toISO(selectedDate);
        const dayBookings = bookings.filter(b => b.date === iso).sort((a, b) => a.time.localeCompare(b.time));

        const busy = dayBookings.reduce((sum, b) => sum + (b.attendees || 1), 0);
        document.getElementById("day-availability").textContent = `${dayCapacity - busy} slot boş`;

        if (dayBookings.length === 0) {
            list.innerHTML = `<div class="text-center py-8 text-slate-500 text-sm">Bu gün için randevu bulunmuyor.</div>`;
            return;
        }

        dayBookings.forEach(b => {
            const inst = instructors.find(i => i.id_name === b.instructor);
            const card = document.createElement("div");
            card.className = "panel bg-slate-800/40 border-slate-700/50 p-4 flex justify-between items-center group";
            card.innerHTML = `
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 rounded-xl flex flex-col items-center justify-center text-xs font-bold" style="background:${inst?.color}20; color:${inst?.color}">
                        <span>${b.time}</span>
                    </div>
                    <div>
                        <h3 class="font-bold text-sm">${b.title}</h3>
                        <p class="text-xs text-slate-400">${b.client} • ${inst?.name}</p>
                    </div>
                </div>
                <div class="flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                    <button onclick="editBooking(${b.id})" class="p-2 hover:text-cyan-400"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg></button>
                    <button onclick="deleteBooking(${b.id})" class="p-2 hover:text-red-400"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg></button>
                </div>
            `;
            list.appendChild(card);
        });
    }

    function renderSlotOptions() {
        const select = document.getElementById("slot-select");
        const instructorId = document.getElementById("instructor-select").value;
        const attendees = parseInt(document.getElementById("attendees").value || 1);
        const iso = toISO(selectedDate);
        
        const taken = bookings
            .filter(b => b.date === iso && b.instructor === instructorId && b.id !== editingId)
            .map(b => ({ start: timeToMins(b.time), end: timeToMins(b.time) + b.duration }));

        select.innerHTML = "";
        for (let m = startHour * 60; m < endHour * 60; m += slotMinutes) {
            const time = minsToTime(m);
            const end = m + (attendees * slotMinutes);
            const isTaken = taken.some(t => m < t.end && end > t.start);
            const isOver = end > endHour * 60;

            const opt = document.createElement("option");
            opt.value = time;
            opt.textContent = time;
            opt.disabled = isTaken || isOver;
            select.appendChild(opt);
        }
    }

    function renderInstructorSelect() {
        const select = document.getElementById("instructor-select");
        select.innerHTML = instructors.map(i => `<option value="${i.id_name}">${i.name}</option>`).join("");
    }

    // Helpers
    function selectDate(date) {
        selectedDate = date;
        document.getElementById("selected-date-label").textContent = `${date.getDate()} ${monthNames[date.getMonth()]} ${date.getFullYear()}`;
        renderCalendar();
        renderBookings();
        renderSlotOptions();
    }

    function changeMonth(delta) {
        currentMonth += delta;
        if (currentMonth < 0) { currentMonth = 11; currentYear--; }
        if (currentMonth > 11) { currentMonth = 0; currentYear++; }
        renderCalendar();
    }

    function resetForm() {
        editingId = null;
        document.getElementById("appointment-form").reset();
        document.getElementById("save-btn").textContent = "Kaydet";
        renderSlotOptions();
    }

    window.editBooking = (id) => {
        const b = bookings.find(x => x.id === id);
        if (!b) return;
        editingId = id;
        document.getElementById("instructor-select").value = b.instructor;
        document.getElementById("title-input").value = b.title;
        document.getElementById("attendees").value = b.attendees;
        document.getElementById("full-name").value = b.client;
        document.getElementById("phone").value = b.phone;
        document.getElementById("note-input").value = b.note;
        document.getElementById("save-btn").textContent = "Güncelle";
        renderSlotOptions();
        document.getElementById("slot-select").value = b.time;
    };

    window.deleteBooking = (id) => deleteAppointment(id);

    function updateClock() {
        const now = new Date();
        document.getElementById("live-date").textContent = `${now.getDate()} ${monthNames[now.getMonth()]}`;
        document.getElementById("live-time").textContent = now.toLocaleTimeString('tr-TR');
    }

    function toISO(d) {
        const year = d.getFullYear();
        const month = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }
    function timeToMins(t) { const [h, m] = t.split(':').map(Number); return h * 60 + m; }
    function minsToTime(m) { return `${String(Math.floor(m/60)).padStart(2,'0')}:${String(m%60).padStart(2,'0')}`; }

    function printDay() { window.print(); }

    init();
})();
</script>
</body>
</html>
